$(document).on("turbolinks:load", function() {
	let place_data = $('#map').data('places');
	if (place_data && place_data.length) {
		var map = L.map('map');
	
		// create the tile layer with correct attribution
		var osmUrl='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
		var osmAttrib='Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
		var osm = new L.TileLayer(osmUrl, {minZoom: 2, maxZoom: 20, attribution: osmAttrib});		
		map.addLayer(osm);

		var markers = L.markerClusterGroup();

		for(let i=0;i<place_data.length;i++) {
			let current_place = place_data[i];
			let latitude = current_place.latitude;
			let longitude = current_place.longitude;
			
			if (longitude && latitude) {
				let marker = L.marker([latitude, longitude]);
				//marker.addTo(map);
				markers.addLayer(marker);
				let markerText = `<b><a href=${current_place.link}>${current_place.name}</a></b>`;
				marker.bindPopup(markerText).openPopup();
			}
		}

		map.addLayer(markers);
		map.setView(new L.LatLng(53.95763, -1.08271), 9); // Center on york
	}	
});
